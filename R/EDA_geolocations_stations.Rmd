---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(plotly)
library(leaflet)
source('service/db_service.R')

library(lubridate)
```


#load data

```{r}
# 1- we need a list of DWD stations with coordinates for PM10:
dwd.stations<- load.dwd.stations.geo('PM10')

# 2 we need the list of sensors with the nearest dwd station infos:
luftdaten.sensors<- read_df_from_db('sensors_luftdaten') %>% filter(sensor_type_id==14 | sensor_type_id==17)

# 3 load proximity table and add to luftdaten_sensors
proximity <- read_df_from_db('luftdaten_dwd_nearest_station')

luftdaten.sensors <- merge(luftdaten.sensors,proximity,by='location_id',all.x=T)
luftdaten.sensors <- luftdaten.sensors%>% mutate_at(c('location_longitude','location_latitude','location_altitude'),as.numeric)

luftdaten.sensors$location_latitude_jitter <- jitter(luftdaten.sensors$location_latitude,factor= 0.01)
luftdaten.sensors$location_longitude_jitter <- jitter(luftdaten.sensors$location_longitude,factor= 0.01)
```


# map
```{r}

pal <- colorFactor(
  palette = "Spectral",
  domain = luftdaten.sensors$sensor_type_id)

m <- leaflet() %>% setView(lng = 13.3493, lat = 52.5430, zoom = 7)
m %>% addProviderTiles(providers$Stamen.Toner) %>%   addCircleMarkers(data = dwd.stations,lng = ~longitude,lat = ~latitude,radius=6,label = ~paste(idx,name,sep = ' - '),stroke = TRUE, fillOpacity = 1) %>%   addCircleMarkers(data = luftdaten.sensors,lng = ~location_longitude_jitter,lat = ~location_latitude_jitter,radius=5,stroke = FALSE, color=~pal(sensor_type_id),fillOpacity = 1,label = ~paste0('location_id: ',as.character(location_id)))
```


## combine DWD data with Luftdaten on PM10


#
```{r}



```

## select specific sensor
```{r}
df.dwd <- load.dwd.data('DERP010')
df <- prepare.data('DERP010',c(244))
spreado <- df  %>% select(-sensor_id) %>% spread(variable,value)
```


```{r}
p<-ggplot(df,aes(datetime,value,color=variable))+ geom_line(size=.2)+ theme_minimal()
ggplotly(p)
```

```{r}
library(viridis)
p<-ggplot(spreado,aes(humidity,log(PM10/P1+1),color=temperature,alpha=.5))+geom_point()+scale_color_viridis("Temp C")
ggplotly(p)
```

```{r}
p<-ggplot(spreado %>% filter(humidity>70),aes(P1,PM10,color=humidity,alpha=.5))+geom_point()+scale_color_viridis("Humidity %")+ geom_abline(intercept = 0, slope = 1)+ geom_smooth()+ geom_abline()
ggplotly(p)
```

#
```{r}
library(randomForest)
data.df <- spreado %>% filter(!is.na(P1) & !is.na(PM10)) #%>% filter(humidity>70)
fit <- lm(data=data.df,P1~humidity+temperature+PM10)
print(summary(fit))

data.df$predicted.lm <- predict(fit)
ggplot(data.df,aes(P1,predicted.lm,color=humidity))+ geom_point()+geom_abline(intercept = 0)
```
```{r}
model.rf <- randomForest(P1~humidity+temperature+PM10, data = data.df, ntree = 500, na.action = na.omit)

data.df$predicted.rf <- predict(model.rf)
ggplot(data.df,aes(predicted.lm,predicted.rf,color=humidity))+ geom_point()+ geom_abline(intercept = 0)
```

## HÃ¤hnel

```{r}
rh <- data.df$humidity/100
data.df$haehnel <- data.df$P1*((1-rh)^.01)

ggplot(data.df,aes(PM10,haehnel))+ geom_point()+ geom_abline(intercept = 0)
```

```{r}
ggplot(data.df,aes(haehnel,PM10,color=humidity))+ geom_point()+ geom_abline(intercept = 0)
humidity.x <-seq(0,1,1/100)
df.rh <- data.frame(rh=humidity.x)
df.rh$haehnel <- (1-df.rh$rh)^.6
ggplot(df.rh,aes(rh,haehnel))+ geom_point()
```

