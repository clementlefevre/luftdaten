---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
library(tidyverse)
library(plotly)
library(leaflet)
source('loadData.R')
library(lubridate)
```


#load data


```{r}
tables <- list_tables_from_DB()
print(tables)


df_dwd_PM10 <-  read_df_from_db('dwd_data_1H')
df_dwd_PM10 <- df_dwd_PM10 %>% filter(pollutant=='PM10') %>% rename(variable=pollutant,sensor_id=station_code)
df_dwd_PM10$datetime <- dmy_hm(df_dwd_PM10$datehour)
df_dwd_PM10 <- df_dwd_PM10 %>% select(sensor_id,datetime,value,variable) 


stations_PM10 <- unique(df_dwd_PM10$sensor_id)
colnames(df_dwd_PM10)<- c("sensor_id" ,"datetime" , "value"  ,   "variable" )

df_dwd_stations <-   read_df_from_db('stations')
df_dwd_stations <- df_dwd_stations %>% filter(idx %in% stations_PM10)
df_sensors_luftdaten <- read_df_from_db('sensors_luftdaten') %>% filter(sensor_type_id!=9 & sensor_type_id!=14)

df_sensors_luftdaten<- df_sensors_luftdaten %>% mutate_at(c('location_latitude','location_longitude','location_altitude'),as.numeric)
```
## find nearest DWD Stations :

```{r}
library(geosphere)
set1<- df_sensors_luftdaten %>% select(location_longitude,location_latitude) # %>% as.matrix
set2<- df_dwd_stations %>% select(longitude,latitude)  #%>% as.matrix

get.distance <-  function(p1,p2) {
    dst <- distm(p1, p2, fun = distHaversine)
    return(dst)
}

#dist.mini <- function(y) min(apply(set2, 1, function(x) min(get.distance (x,y))))

#dist.mini.idx <- function(y) which.min(apply(set2, 1, function(x) min(get.distance (x,y))))
dist.mini.idx <- function(y) which.min(apply(set2, 1, function(x) min(distHaversine(x,y))))

# very long to compute, must compute distance between each sensors and each dwd station
mini.idx.result <- apply(set1, 1, dist.mini.idx )

df_sensors_luftdaten$idx.nearest.dwd <- mini.idx.result
df_dwd_stations <- df_dwd_stations %>% mutate(id = row_number())
df_sensors_luftdaten <- merge(df_sensors_luftdaten,df_dwd_stations,by.x='idx.nearest.dwd',by.y='id')

coord.sensors <- df_sensors_luftdaten%>% select(location_longitude,location_latitude) 
coord.dwd <- df_sensors_luftdaten %>% select(longitude,latitude)
df_sensors_luftdaten$distance.to.dwd<-distHaversine(coord.sensors,coord.dwd)

```





# map
```{r}
m <- leaflet() %>% setView(lng = 13.3493, lat = 52.5430, zoom = 7)
m %>% addProviderTiles(providers$Stamen.Toner) %>%   addCircleMarkers(data = df_dwd_stations,lng = ~longitude,lat = ~latitude,radius=6,label = ~paste(idx,name,sep = ' - '),stroke = TRUE, fillOpacity = 1) %>%   addCircleMarkers(data = df_sensors_luftdaten,lng = ~location_longitude,lat = ~location_latitude,radius=3,stroke = FALSE, color='red',fillOpacity = 1,label = ~paste0('location_id: ',as.character(location_id)))
```

## combine DWD data with Luftdaten on PM10


#
```{r}

prepare.data <- function(dwdStationCode,location.id){

df <- load.luftdaten.data(location.id)
df$datetime <- ymd_hms(df$datehour)
df <- df %>% select(sensor_id,datetime,value,variable)
df$sensor_id <- as.character(df$sensor_id)

df <- bind_rows(df_dwd_PM10 %>% filter(sensor_id==dwdStationCode),df) %>%  distinct(sensor_id,datetime,variable, .keep_all = TRUE)

start.data <-  df %>% filter(variable=='P1') %>% pull(datetime)
df <- df %>% filter(datetime>=min(start.data))

return (df)
}

```

## select specific sensor
```{r}

df <- prepare.data('DERP010',c(10621))

spreado <- df  %>% select(-sensor_id) %>% spread(variable,value)
```


```{r}
p<-ggplot(df,aes(datetime,value,color=variable))+ geom_line(size=.2)+ theme_minimal()
ggplotly(p)
```

```{r}
library(viridis)
p<-ggplot(spreado,aes(humidity,log(PM10/P1+1),color=temperature,alpha=.5))+geom_point()+scale_color_viridis("Temp C")
ggplotly(p)
```

```{r}
p<-ggplot(spreado %>% filter(humidity>70),aes(P1,PM10,color=humidity,alpha=.5))+geom_point()+scale_color_viridis("Humidity %")+ geom_abline(intercept = 0, slope = 1)+ geom_smooth()+ geom_abline()
ggplotly(p)
```

#
```{r}
library(randomForest)
data.df <- spreado %>% filter(!is.na(P1) & !is.na(PM10)) #%>% filter(humidity>70)
fit <- lm(data=data.df,P1~humidity+temperature+PM10)
print(summary(fit))

data.df$predicted.lm <- predict(fit)
ggplot(data.df,aes(P1,predicted.lm,color=humidity))+ geom_point()+geom_abline(intercept = 0)
```
```{r}
model.rf <- randomForest(P1~humidity+temperature+PM10, data = data.df, ntree = 500, na.action = na.omit)

data.df$predicted.rf <- predict(model.rf)
ggplot(data.df,aes(predicted.lm,predicted.rf,color=humidity))+ geom_point()+ geom_abline(intercept = 0)
```

## HÃ¤hnel

```{r}
rh <- data.df$humidity/100
data.df$haehnel <- data.df$P1*((1-rh)^.01)

ggplot(data.df,aes(PM10,haehnel))+ geom_point()+ geom_abline(intercept = 0)
```

```{r}
ggplot(data.df,aes(haehnel,PM10,color=humidity))+ geom_point()+ geom_abline(intercept = 0)
humidity.x <-seq(0,1,1/100)
df.rh <- data.frame(rh=humidity.x)
df.rh$haehnel <- (1-df.rh$rh)^.6
ggplot(df.rh,aes(rh,haehnel))+ geom_point()
```

